package com.weedmaps.dataaccess.repo.impl;

import java.util.Date;
import java.util.List;
import java.util.Objects;

import org.springframework.stereotype.Repository;

import com.weedmaps.dataaccess.entity.${type.name};
import com.weedmaps.dataaccess.repo.GraphQLReadOnlyRepository;

import lombok.extern.slf4j.Slf4j;

@Slf4j
@Repository
public class ${type.name}Repo extends GraphQLReadOnlyRepository<${type.name}> {

    private static final String ENTITY = ${type.name}.getEntityName();


    protected String getCountQuery(String name, String filter) {
        StringBuilder queryBuilder = new StringBuilder();

        queryBuilder.append("query GET_${type.tableName}_" + name +" {\r\n");
        queryBuilder.append(" ${type.tableName}_aggregate ");
        if(filter != null && filter.trim().length() >= 1){
            queryBuilder.append(filter);
        }
        queryBuilder.append("{\r\n");
        queryBuilder.append("   aggregate {\r\n");
        queryBuilder.append("       count\r\n");
        queryBuilder.append("   }\r\n");
        queryBuilder.append(" }\r\n");
        queryBuilder.append("}\r\n");

        return queryBuilder.toString();
    }

    protected String getByIdQuery(String name, Integer id) {

        StringBuilder queryBuilder = new StringBuilder();

        queryBuilder.append("query GET_${type.tableName}_" + name +" {\r\n");
        queryBuilder.append(" ${type.tableName}_by_pk(id: "+ id +") ");
        getAllFields(queryBuilder);
        queryBuilder.append("}\r\n");

        return queryBuilder.toString();
    }

    protected String getQuery(String name, String filter) {

        StringBuilder queryBuilder = new StringBuilder();

        queryBuilder.append("query GET_${type.tableName}_" + name +" {\r\n");
        queryBuilder.append(" $type.tableName ");
        if(filter != null && filter.trim().length() >= 1){
            queryBuilder.append(filter);
        }
        getAllFields(queryBuilder);
        queryBuilder.append("}\r\n");

        return queryBuilder.toString();
    }

    private void getAllFields(StringBuilder queryBuilder){
        queryBuilder.append("{\r\n");
        queryBuilder.append("   id\r\n");
#foreach( $field in $type.fields)
        queryBuilder.append("   $field.tableFieldName\r\n");
#end
        queryBuilder.append("   is_deleted\r\n");
        queryBuilder.append("   created_at\r\n");
        queryBuilder.append("   created_by\r\n");
        queryBuilder.append("   updated_at\r\n");
        queryBuilder.append("   updated_by\r\n");
        queryBuilder.append(" }\r\n");
    }

    public List<$type.name> getAll${type.plural}(){
        final String name = "All";
        final String filter = "";
        log.debug("Fetching query for ${type.name}(s): {} with filter: {}", name, filter);
        return execute(name, filter, ENTITY, ${type.name}.class);
    } 

    public List<$type.name> getActive${type.plural}(){
        final String name = "Active";
        final String filter = "(where: {is_deleted: {_eq: false}})";
        log.debug("Fetching query for ${type.name}(s): {} with filter: {}", name, filter);
        return execute(name, filter, ENTITY, ${type.name}.class);
    } 

    public List<$type.name> getActive${type.plural}After(Date lastModified){
        Objects.requireNonNull(lastModified);
        String lastModifiedDate = YYYY_MM_DD_FORMATTER.format(lastModified);
        final String name = "UpdatedAfter";
        final String filter = "(where: {is_deleted: {_eq: false}, updated_at: {_gte: \"" + lastModifiedDate + "\"}})";
        log.debug("Fetching query for ${type.name}(s): {} with filter: {}", name, filter);
        return execute(name, filter, ENTITY, ${type.name}.class);
    } 

    @Override
    public List<$type.name> findAll(){
        return getAll${type.plural}();
    } 

    @Override
    public List<$type.name> findAllById(Iterable<Integer> ids){
        final String name = "AllByIds";
        final String filter = "(where: {id: {_in: " + ids + "}})";
        log.debug("Fetching query for ${type.name}(s): {} with filter: {}", name, filter);
        return execute(name, filter, ENTITY, ${type.name}.class);
    } 

    @Override
    public $type.name getOne(Integer id){
        return getById(id);
    } 

    @Override
    public $type.name getById(Integer id){
        final String name = "GetById";
        final String filter = "(where: {id: {_eq: " + id + "}})";
        log.debug("Fetching query for ${type.name}(s): {} with filter: {}", name, filter);
        return execute(name, id, ENTITY, ${type.name}.class);
    } 
    
    @Override
    public long count() {
        final String name = "Count";
        log.debug("Count query for ${type.name}(s): {} ", name);
        return execute(name, ENTITY, ${type.name}.class);
    }

#foreach( $query in $type.queries )
    public List<$type.name> get${query.name}(
#foreach( $field in $query.fields )
#if ( $velocityCount < $query.fields.size() )
            final List<Integer> ${field},
#else
            final List<Integer> ${field}) {
#end
#end
#foreach( $field in $query.fields )
        Objects.requireNonNull($field);
#end
        final String name = "${query.name}";
        final String filter = "${query.filter}";
        log.debug("Fetching query for ${type.name}(s): {} with filter: {}", name, filter);
        return execute(name, filter, ENTITY, ${type.name}.class);
    }
#end

}